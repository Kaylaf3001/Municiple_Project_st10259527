@using Municiple_Project_st10259527.Services.DataStructures
@using System.Linq
@model (Municiple_Project_st10259527.Services.DataStructures.BasicTree<Municiple_Project_st10259527.Models.ServiceRequestModel> Tree, Municiple_Project_st10259527.Services.DataStructures.MinHeap<ServiceRequestPriority, Municiple_Project_st10259527.Models.ServiceRequestModel> Heap, Municiple_Project_st10259527.Services.DataStructures.Graph<Municiple_Project_st10259527.Models.ServiceRequestModel> Graph)

@{
    ViewData["Title"] = "Manage Service Requests";
    Layout = "_AdminLayout";
}

<style>
    .page-container {
        min-height: calc(100vh - 200px);
        padding-bottom: 2rem;
    }

    .card {
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        background: #fff;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        margin-bottom: 2rem;
    }

    .card-header {
        background: #0d2b52;
        color: #fff;
        padding: 1rem 1.5rem;
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
        font-weight: 600;
        font-size: 1.1rem;
    }

    .card-body {
        padding: 1.5rem;
    }

    .badge {
        padding: 0.5em 0.8em;
        font-size: 0.85rem;
        font-weight: 600;
        border-radius: 4px;
    }

    .table-responsive {
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 0 0 1px rgba(0,0,0,0.05);
    }

    .table {
        margin-bottom: 0;
    }

        .table th {
            background-color: #f8f9fa;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
            padding: 1rem;
            border-bottom: 2px solid #e9ecef;
        }

        .table td {
            padding: 1rem;
            vertical-align: middle;
            border-color: #edf2f7;
        }

        .table tbody tr {
            transition: background-color 0.2s;
        }

            .table tbody tr:hover {
                background-color: #f8fafc;
            }

    .form-select {
        min-width: 150px;
    }

    .action-form {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    @@media (max-width: 768px) {
        .action-form {
            flex-direction: column;
        }

            .action-form .btn {
                width: 100%;
            }
    }
</style>
<div class="container page-container">
    <form id="antiForgeryForm" method="post" style="display:none;">
        @Html.AntiForgeryToken()
    </form>
    <div class="d-flex justify-content-between align-items-center mb-4 pt-4">
        <div class="d-flex flex-column">
            <a href="@Url.Action("Dashboard", "Admin")" class="text-decoration-none text-muted mb-2 d-flex align-items-center" style="font-size: 0.9rem;">
                <i class="bi bi-arrow-left me-1"></i> Back to Dashboard
            </a>
            <h2 class="m-0">Manage Service Requests</h2>
            <p class="text-muted mb-0" style="font-size: 0.95rem;">Review, update, and prioritize all requests</p>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">All Requests</div>
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <div></div>
                        <form method="get" asp-action="ManageServiceRequest" asp-controller="ServiceRequestAdmin" class="d-flex align-items-center gap-2">
                            <select name="statusFilter" class="form-select form-select-sm" style="max-width:180px">
                                {
                                    var sf = ViewData["StatusFilter"] as string;
                                }
                                <option value="" selected="@string.IsNullOrWhiteSpace(ViewData["StatusFilter"] as string)">All Statuses</option>
                                <option value="Submitted" selected="@((ViewData["StatusFilter"] as string) == "Submitted")">Submitted</option>
                                <option value="InProgress" selected="@((ViewData["StatusFilter"] as string) == "InProgress")">In Progress</option>
                                <option value="OnHold" selected="@((ViewData["StatusFilter"] as string) == "OnHold")">On Hold</option>
                                <option value="Completed" selected="@((ViewData["StatusFilter"] as string) == "Completed")">Completed</option>
                                <option value="Cancelled" selected="@((ViewData["StatusFilter"] as string) == "Cancelled")">Cancelled</option>
                            </select>
                            <select name="categoryFilter" class="form-select form-select-sm" style="max-width:200px">
                                <option value="">All Categories</option>
                                <option value="Infrastructure" selected="@((ViewData["CategoryFilter"] as string) == "Infrastructure")">Infrastructure</option>
                                <option value="Utilities" selected="@((ViewData["CategoryFilter"] as string) == "Utilities")">Utilities</option>
                                <option value="Electrical" selected="@((ViewData["CategoryFilter"] as string) == "Electrical")">Electrical</option>
                                <option value="Waste" selected="@((ViewData["CategoryFilter"] as string) == "Waste")">Waste</option>
                                <option value="Health" selected="@((ViewData["CategoryFilter"] as string) == "Health")">Health</option>
                                <option value="Safety" selected="@((ViewData["CategoryFilter"] as string) == "Safety")">Safety</option>
                                <option value="Fire" selected="@((ViewData["CategoryFilter"] as string) == "Fire")">Fire</option>
                                <option value="Parks" selected="@((ViewData["CategoryFilter"] as string) == "Parks")">Parks</option>
                                <option value="General" selected="@((ViewData["CategoryFilter"] as string) == "General")">General</option>
                            </select>
                            <input name="priorityFilter" type="number" min="1" max="3" class="form-control form-control-sm" style="max-width:100px" placeholder="Priority" value="@ViewData["PriorityFilter"]" />
                            <select name="locationFilter" class="form-select form-select-sm" style="max-width:320px">
                                <option value="">All Locations</option>
                                @{
                                    var selectedLocation = ViewData["LocationFilter"] as string;
                                    foreach (var loc in Municiple_Project_st10259527.Services.LocationService.WesternCapeLocations.Values)
                                    {
                                        <option value="@loc" selected="@(loc == selectedLocation)">@loc</option>
                                    }
                                }
                            </select>
                            <button class="btn btn-sm btn-outline-primary" type="submit">Filter</button>
                        </form>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle" style="table-layout: fixed;">
                            <thead>
                                <tr>
                                    <th style="width: 60px;">ID</th>
                                    <th>Title</th>
                                    <th style="width: 120px;">Status</th>
                                    <th style="width: 120px;">Priority</th>
                                    <th style="width: 180px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.Tree?.Root == null)
                                {
                                    <tr><td colspan="5" class="text-center">No service requests.</td></tr>
                                }
                                else
                                {
                                    await RenderNodeSimple(Model.Tree.Root);
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card mb-3" style="min-width: 320px;">
                <div class="card-header">Next by Priority</div>
                <div class="card-body">
                    @{
                        // Model.Heap?.Peek() returns a nullable tuple: (ServiceRequestPriority, ServiceRequestModel)?
                        var topNullable = Model.Heap?.Peek();

                        // Check the nullable before accessing Item1/Item2
                        if (!topNullable.HasValue || topNullable.Value.Item2 == null)
                        {
                            <div class="text-muted">No pending requests</div>
                        }
                        else
                        {
                            var top = topNullable.Value; // (ServiceRequestPriority, ServiceRequestModel)
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <div class="fw-semibold">@top.Item2.Title</div>
                                    <div class="small text-muted">
                                        Priority: @top.Item2.Priority • 
                                        Submitted: <span class="local-datetime" data-utc="@top.Item2.SubmittedAt.ToString("o")">@top.Item2.SubmittedAt.ToString("g")</span> • 
                                        ID: @top.Item2.RequestId
                                    </div>
                                </div>
                                <span class="badge bg-secondary">@top.Item2.Status</span>
                            </div>
                        }
                    }
                </div>
            </div>

            <!-- Related Service Requests Card -->
            <div class="card mb-3" style="min-width: 320px;">
                <div class="card-header">Related Service Requests</div>
                <div class="card-body">
                    @{
                        var mstEdges = Model.Graph?.PrimMst();
                        if (mstEdges == null || !mstEdges.Any())
                        {
                            <div class="text-muted">No related requests found</div>
                        }
                        else
                        {
                            <div class="d-flex flex-column gap-3">
                                @foreach (var edge in mstEdges.Take(5)) // Show top 5 related requests
                                {
                                    var from = edge.Item1.Val;
                                    var to = edge.Item2.Val;
                                    var weight = edge.Item3;
                                    var reason = GetConnectionReason(from, to, weight);
                                    
                                    <div class="border-bottom pb-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <div class="fw-semibold">@from.Title</div>
                                                <div class="small text-muted">ID: @from.RequestId • @from.Category</div>
                                            </div>
                                            <span class="badge @Badge(from.Status)">@from.Status</span>
                                        </div>
                                        <div class="d-flex justify-content-center my-1">
                                            <i class="bi bi-arrow-down text-muted"></i>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <div class="fw-semibold">@to.Title</div>
                                                <div class="small text-muted">ID: @to.RequestId • @to.Category</div>
                                            </div>
                                            <span class="badge @Badge(to.Status)">@to.Status</span>
                                        </div>
                                        <div class="small text-muted mt-1 d-flex align-items-center">
                                            <span>Reason: @reason</span>
                                            <i class="bi bi-info-circle ms-2" data-bs-toggle="tooltip" title="@reason"></i>
                                        </div>
                                        <div class="d-flex justify-content-end">
                                            <a asp-action="Detail" asp-route-id="@to.RequestId" class="btn btn-sm btn-outline-primary">
                                                <i class="bi bi-eye"></i> View
                                            </a>
                                        </div>
                                    </div>
                                }
                            </div>
                            <div class="mt-2 small text-muted">
                                <i class="bi bi-lightbulb"></i> <strong>Tip:</strong> Consider processing related requests together to save time on travel and setup.
                            </div>
                        }
                    }
                </div>
            </div>

            <!-- Traversal from Request Card (BFS) -->
            @{
                var startIdObj = ViewData["StartId"]; 
                int parsedStartId;
                bool hasStart = startIdObj != null && int.TryParse(startIdObj.ToString(), out parsedStartId);
                var startNode = hasStart ? Model.Graph?.Nodes()?.FirstOrDefault(n => n.Val != null && n.Val.RequestId == parsedStartId) : null;
            }
            @if (hasStart)
            {
                <div class="card mb-3" style="min-width: 320px;">
                    <div class="card-header">Traversal from Request #@parsedStartId</div>
                    <div class="card-body">
                        @if (startNode == null)
                        {
                            <div class="text-muted">Start request not found in graph.</div>
                        }
                        else
                        {
                            var bfs = Model.Graph?.Bfs(startNode)?.Take(8) ?? Enumerable.Empty<Municiple_Project_st10259527.Models.ServiceRequestModel>();
                            if (!bfs.Any())
                            {
                                <div class="text-muted">No connected requests found.</div>
                            }
                            else
                            {
                                <div class="list-group small">
                                @foreach (var r in bfs)
                                {
                                    <a asp-action="Detail" asp-route-id="@r.RequestId" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                        <div>
                                            <div class="fw-semibold text-truncate" style="max-width: 220px;">@r.Title</div>
                                            <div class="text-muted">ID: @r.RequestId • @r.Category</div>
                                            <div class="text-muted">Reason: Connected (BFS)</div>
                                        </div>
                                        <span class="badge @Badge(r.Status)">@r.Status</span>
                                    </a>
                                }
                                </div>
                            }
                        }
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@functions {
    private string GetConnectionReason(Municiple_Project_st10259527.Models.ServiceRequestModel r1, Municiple_Project_st10259527.Models.ServiceRequestModel r2, int weight)
    {
        if (r1.Status == r2.Status) return "Same status";
        if (!string.IsNullOrEmpty(r1.Category) && r1.Category == r2.Category) return "Same category";
        if (!string.IsNullOrEmpty(r1.Location) && r1.Location == r2.Location) return "Same location";
        return "Related";
    }

    private string Badge(Municiple_Project_st10259527.Models.ServiceRequestStatus status)
    {
        return status switch
        {
            Municiple_Project_st10259527.Models.ServiceRequestStatus.Submitted => "bg-warning text-dark",
            Municiple_Project_st10259527.Models.ServiceRequestStatus.InProgress => "bg-info text-dark",
            Municiple_Project_st10259527.Models.ServiceRequestStatus.OnHold => "bg-secondary",
            Municiple_Project_st10259527.Models.ServiceRequestStatus.Completed => "bg-success",
            Municiple_Project_st10259527.Models.ServiceRequestStatus.Cancelled => "bg-danger",
            _ => "bg-secondary"
        };
    }

    private async Task RenderNodeSimple(Municiple_Project_st10259527.Services.DataStructures.TreeNode<Municiple_Project_st10259527.Models.ServiceRequestModel> node)
    {
        if (node == null) return;
        var r = node.Value;
        <tr>
            <td>@r.RequestId</td>
            <td>@r.Title</td>
            <td><span class="badge @Badge(r.Status)">@r.Status</span></td>
            <td><span class="badge bg-light text-dark">Priority @r.Priority</span></td>
            <td class="d-flex gap-1">
                <a asp-action="Detail" asp-route-id="@r.RequestId" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-eye"></i> View
                </a>
                @if (r.Status != Municiple_Project_st10259527.Models.ServiceRequestStatus.Completed && 
                     r.Status != Municiple_Project_st10259527.Models.ServiceRequestStatus.Cancelled)
                {
                    <button class="btn btn-sm btn-success" onclick="completeRequest(@r.RequestId)" title="Mark as completed">
                        <i class="bi bi-check-circle"></i>
                    </button>
                }
            </td>
        </tr>
        await RenderNodeSimple(node.FirstChild);
        await RenderNodeSimple(node.NextSibling);
    }
}

<script>
// Convert UTC dates to local time
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.local-datetime').forEach(function(element) {
        const utcDate = new Date(element.getAttribute('data-utc'));
        if (!isNaN(utcDate.getTime())) {
            element.textContent = utcDate.toLocaleString(undefined, {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
        }
    });

    // Existing modal code
    const requestModal = document.getElementById('requestModal');
    requestModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const id = button.getAttribute('data-id');
        document.getElementById('modal-id').textContent = id;
        const formId = document.getElementById('form-id');
        const formPriority = document.getElementById('form-priority');
        formId.value = id;
        document.getElementById('modal-title').textContent = button.getAttribute('data-title');
        document.getElementById('modal-description').textContent = button.getAttribute('data-description');
        document.getElementById('modal-location').textContent = button.getAttribute('data-location');
        document.getElementById('modal-category').textContent = button.getAttribute('data-category');
        const status = button.getAttribute('data-status');
        const statusSelect = document.getElementById('modal-status-select');
        statusSelect.value = status;
        const currentPriority = button.getAttribute('data-priority');
        document.getElementById('modal-priority').textContent = 'Priority ' + currentPriority;
        formPriority.value = currentPriority;
        document.getElementById('modal-userid').textContent = button.getAttribute('data-userid');

        // No extra JS submit handler needed; form posts directly with anti-forgery token
    });

    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

// Function to handle the complete button click
async function completeRequest(id) {
    if (!confirm('Are you sure you want to mark this request as completed?')) {
        return;
    }

    try {
        const response = await fetch('@Url.Action("CompleteRequest", "ServiceRequestAdmin")', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
            },
            body: `id=${id}`
        });

        const result = await response.json();
        
        if (result.success) {
            showToast('Request completed successfully!', 'success');

            const relatedList = document.getElementById('relatedRequestsList');
            if (result.relatedRequests && result.relatedRequests.length > 0) {
                relatedList.innerHTML = `
                    <p class="mb-3">Here are some related requests you might want to work on next:</p>
                    <div class="row g-3">
                        ${result.relatedRequests.map((req, index) => `
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="card-title mb-0">${escapeHtml(req.title)}</h6>
                                            <span class="badge ${getStatusBadgeClass(req.status)}">${req.status}</span>
                                        </div>
                                        <div class="small text-muted mb-2">ID: ${req.id}</div>
                                        <div class="mb-2">
                                            <i class="bi bi-tag me-1"></i> ${escapeHtml(req.category)}<br>
                                            <i class="bi bi-geo-alt me-1"></i> ${escapeHtml(req.location)}<br>
                                            <i class="bi bi-flag me-1"></i> Priority: ${req.priority}
                                        </div>
                                        <div class="small text-muted d-flex align-items-center">
                                            <span>Reason: ${escapeHtml(req.reason || 'Connected')}</span>
                                            <i class="bi bi-info-circle ms-2" data-bs-toggle="tooltip" title="${escapeHtml(req.reason || 'Connected')}"></i>
                                        </div>
                                        <a href="/ServiceRequestAdmin/ManageServiceRequest?requestId=${req.id}" 
                                           class="btn btn-sm btn-outline-primary w-100">
                                            <i class="bi bi-arrow-right-circle me-1"></i> View Request
                                        </a>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                relatedList.innerHTML = `
                    <div class="text-center py-4">
                        <i class="bi bi-check2-circle fs-1 text-success d-block mb-2"></i>
                        <p class="mb-0">No strong related requests found right now.</p>
                    </div>`;
            }

            // Initialize tooltips for dynamically added elements
            const newTooltipTriggerList = [].slice.call(document.querySelectorAll('#relatedRequestsList [data-bs-toggle="tooltip"]'));
            newTooltipTriggerList.forEach(function (el) { new bootstrap.Tooltip(el); });

            // Show the modal and redirect to detail after close
            const modalEl = document.getElementById('relatedRequestsModal');
            const modal = new bootstrap.Modal(modalEl);
            modal.show();
            modalEl.addEventListener('hidden.bs.modal', function () {
                if (result.redirectUrl) window.location.href = result.redirectUrl;
            }, { once: true });
        } else {
            showToast(result.error || 'Error completing request', 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('An error occurred while processing your request.', 'danger');
    }
}

// Helper function to get badge class based on status
function getStatusBadgeClass(status) {
    const statusMap = {
        'Submitted': 'bg-warning text-dark',
        'InProgress': 'bg-info text-dark',
        'OnHold': 'bg-secondary',
        'Completed': 'bg-success',
        'Cancelled': 'bg-danger'
    };
    return statusMap[status] || 'bg-secondary';
}

// Helper function to escape HTML
function escapeHtml(unsafe) {
    if (!unsafe) return '';
    return unsafe
        .toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

// Helper function to show toast messages
function showToast(message, type = 'success') {
    const toastContainer = document.getElementById('toastContainer') || document.body;
    const toastId = 'toast-' + Date.now();
    
    const toast = document.createElement('div');
    toast.id = toastId;
    toast.className = `toast align-items-center text-white bg-${type} border-0 fade show`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    
    // Auto-remove toast after 5 seconds
    setTimeout(() => {
        const bsToast = new bootstrap.Toast(toast);
        bsToast.hide();
        toast.addEventListener('hidden.bs.toast', () => {
            toast.remove();
        });
    }, 5000);
}
</script>

<!-- Related Requests Modal -->
<div class="modal fade" id="relatedRequestsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Related Service Requests</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="relatedRequestsList">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Finding related requests...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="toastContainer" class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <!-- Toasts will be inserted here by JavaScript -->
</div>

<style>
    /* Toast styles */
    .toast {
        min-width: 250px;
        margin-bottom: 1rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        animation: fadeIn 0.3s ease-out;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>