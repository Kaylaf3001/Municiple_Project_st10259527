@model (Municiple_Project_st10259527.Services.DataStructures.BasicTree<Municiple_Project_st10259527.Models.ServiceRequestModel> Tree, Municiple_Project_st10259527.Services.DataStructures.MinHeap<int, Municiple_Project_st10259527.Models.ServiceRequestModel> Heap, Municiple_Project_st10259527.Services.DataStructures.Graph<Municiple_Project_st10259527.Models.ServiceRequestModel> Graph)

@{
    ViewData["Title"] = "Manage Service Requests";
    Layout = "_AdminLayout";
}

<style>
    .page-container {
        min-height: calc(100vh - 200px);
        padding-bottom: 2rem;
    }

    .card {
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        background: #fff;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        margin-bottom: 2rem;
    }

    .card-header {
        background: #0d2b52;
        color: #fff;
        padding: 1rem 1.5rem;
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
        font-weight: 600;
        font-size: 1.1rem;
    }

    .card-body {
        padding: 1.5rem;
    }

    .badge {
        padding: 0.5em 0.8em;
        font-size: 0.85rem;
        font-weight: 600;
        border-radius: 4px;
    }

    .table-responsive {
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 0 0 1px rgba(0,0,0,0.05);
    }

    .table {
        margin-bottom: 0;
    }

        .table th {
            background-color: #f8f9fa;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
            padding: 1rem;
            border-bottom: 2px solid #e9ecef;
        }

        .table td {
            padding: 1rem;
            vertical-align: middle;
            border-color: #edf2f7;
        }

        .table tbody tr {
            transition: background-color 0.2s;
        }

            .table tbody tr:hover {
                background-color: #f8fafc;
            }

    .form-select {
        min-width: 150px;
    }

    .action-form {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    @@media (max-width: 768px) {
        .action-form {
            flex-direction: column;
        }

            .action-form .btn {
                width: 100%;
            }
    }
</style>
<div class="container page-container">
    <div class="d-flex justify-content-between align-items-center mb-4 pt-4">
        <div class="d-flex flex-column">
            <a href="@Url.Action("Dashboard", "Admin")" class="text-decoration-none text-muted mb-2 d-flex align-items-center" style="font-size: 0.9rem;">
                <i class="bi bi-arrow-left me-1"></i> Back to Dashboard
            </a>
            <h2 class="m-0">Manage Service Requests</h2>
            <p class="text-muted mb-0" style="font-size: 0.95rem;">Review, update, and prioritize all requests</p>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">All Requests</div>
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <div></div>
                        <form method="get" asp-action="ManageServiceRequest" asp-controller="ServiceRequestAdmin" class="d-flex align-items-center gap-2">
                            <select name="statusFilter" class="form-select form-select-sm" style="max-width:180px">
                                {
                                    var sf = ViewData["StatusFilter"] as string;
                                }
                                <option value="" selected="@string.IsNullOrWhiteSpace(ViewData["StatusFilter"] as string)">All Statuses</option>
                                <option value="Submitted" selected="@((ViewData["StatusFilter"] as string) == "Submitted")">Submitted</option>
                                <option value="InProgress" selected="@((ViewData["StatusFilter"] as string) == "InProgress")">In Progress</option>
                                <option value="OnHold" selected="@((ViewData["StatusFilter"] as string) == "OnHold")">On Hold</option>
                                <option value="Completed" selected="@((ViewData["StatusFilter"] as string) == "Completed")">Completed</option>
                                <option value="Cancelled" selected="@((ViewData["StatusFilter"] as string) == "Cancelled")">Cancelled</option>
                            </select>
                            <select name="categoryFilter" class="form-select form-select-sm" style="max-width:200px">
                                <option value="">All Categories</option>
                                <option value="Infrastructure" selected="@((ViewData["CategoryFilter"] as string) == "Infrastructure")">Infrastructure</option>
                                <option value="Utilities" selected="@((ViewData["CategoryFilter"] as string) == "Utilities")">Utilities</option>
                                <option value="Electrical" selected="@((ViewData["CategoryFilter"] as string) == "Electrical")">Electrical</option>
                                <option value="Waste" selected="@((ViewData["CategoryFilter"] as string) == "Waste")">Waste</option>
                                <option value="Health" selected="@((ViewData["CategoryFilter"] as string) == "Health")">Health</option>
                                <option value="Safety" selected="@((ViewData["CategoryFilter"] as string) == "Safety")">Safety</option>
                                <option value="Fire" selected="@((ViewData["CategoryFilter"] as string) == "Fire")">Fire</option>
                                <option value="Parks" selected="@((ViewData["CategoryFilter"] as string) == "Parks")">Parks</option>
                                <option value="General" selected="@((ViewData["CategoryFilter"] as string) == "General")">General</option>
                            </select>
                            <input name="priorityFilter" type="number" min="1" max="3" class="form-control form-control-sm" style="max-width:100px" placeholder="Priority" value="@ViewData["PriorityFilter"]" />
                            <select name="locationFilter" class="form-select form-select-sm" style="max-width:320px">
                                <option value="">All Locations</option>
                                @{
                                    var selectedLocation = ViewData["LocationFilter"] as string;
                                    foreach (var loc in Municiple_Project_st10259527.Services.LocationService.WesternCapeLocations.Values)
                                    {
                                        <option value="@loc" selected="@(loc == selectedLocation)">@loc</option>
                                    }
                                }
                            </select>
                            <button class="btn btn-sm btn-outline-primary" type="submit">Filter</button>
                        </form>
                    </div>
            }
                    <div class="table-responsive">
                        <table class="table table-hover align-middle" style="table-layout: fixed;">
                            <thead>
                                <tr>
                                    <th style="width: 60px;">ID</th>
                                    <th>Title</th>
                                    <th style="width: 120px;">Status</th>
                                    <th style="width: 120px;">Priority</th>
                                    <th style="width: 180px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.Tree?.Root == null)
                                {
                                    <tr><td colspan="5" class="text-center">No service requests.</td></tr>
                                }
                                else
                                {
                                    await RenderNodeSimple(Model.Tree.Root);
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card mb-3" style="min-width: 320px;">
                <div class="card-header">Next by Priority</div>
                <div class="card-body">
                    @{
                        // Model.Heap?.Peek() returns a nullable tuple: (int, ServiceRequestModel)?
                        var topNullable = Model.Heap?.Peek();

                        // Check the nullable before accessing Item1/Item2
                        if (!topNullable.HasValue || topNullable.Value.Item2 == null)
                        {
                            <div class="text-muted">No pending requests</div>
                        }
                        else
                        {
                            var top = topNullable.Value; // (int, ServiceRequestModel)
                                                         <div class="d-flex align-items-center justify-content-between">
                                                             <div>
                                                                 <div class="fw-semibold">@top.Item2.Title</div>
                                                                 <div class="small text-muted">Priority: @top.Item1 • ID: @top.Item2.RequestId</div>
                                                             </div>
                                                             <span class="badge bg-secondary">@top.Item2.Status</span>
                                                         </div>
                        }
                    }
                </div>
            </div>
            @if ((ViewData["StartId"] as int?) > 0)
            {
            <div class="card mb-3" style="min-width: 320px;">
                <div class="card-header d-flex align-items-center justify-content-between">
                    <span>
                        Related Requests
                        @{
                            var anchorTitle = "";
                            var sidObj = ViewData["StartId"];
                            int sid = (sidObj is int) ? (int)sidObj : (sidObj is int? ? ((int?)sidObj).GetValueOrDefault() : 0);
                            if (sid > 0 && Model.Graph != null)
                            {
                                var n = Model.Graph.Nodes()?.FirstOrDefault();
                                while (n != null)
                                {
                                    if (n.Val?.RequestId == sid) { anchorTitle = n.Val.Title; break; }
                                    n = n.Next;
                                }
                            }
                            if (!string.IsNullOrWhiteSpace(anchorTitle))
                            {
                                <span class="small text-light ms-2">(from: @anchorTitle)</span>
                            }
                        }
                    </span>
                    <i class="bi bi-info-circle" title="Quick view of other requests that are connected by similar status/priority. Handy for batching."></i>
                </div>
                <div class="card-body">
                    <form method="get" asp-action="ManageServiceRequest" asp-controller="ServiceRequestAdmin" class="d-flex align-items-center gap-2 mb-2">
                        <input type="hidden" name="statusFilter" value="@ViewData["StatusFilter"]" />
                        <input type="hidden" name="categoryFilter" value="@ViewData["CategoryFilter"]" />
                        <input type="hidden" name="priorityFilter" value="@ViewData["PriorityFilter"]" />
                        <input name="locationFilter" class="form-control form-control-sm" style="max-width:200px" placeholder="Start area (e.g. Building A)" value="@ViewData["LocationFilter"]" />
                        <input type="hidden" name="startId" value="@ViewData["StartId"]" />
                        <button class="btn btn-sm btn-outline-primary" type="submit" title="Seed related items from this area">Start</button>
                    </form>
                    @{
                        var seed = (ViewData["LocationFilter"] as string) ?? string.Empty;
                        Municiple_Project_st10259527.Services.DataStructures.Graph<Municiple_Project_st10259527.Models.ServiceRequestModel>.GraphNode start = null;
                        var sidObj2 = ViewData["StartId"];
                        int sid2 = (sidObj2 is int) ? (int)sidObj2 : (sidObj2 is int? ? ((int?)sidObj2).GetValueOrDefault() : 0);
                        if (sid2 > 0)
                        {
                            var n = Model.Graph?.Nodes()?.FirstOrDefault();
                            while (n != null)
                            {
                                if (n.Val?.RequestId == sid2) { start = n; break; }
                                n = n.Next;
                            }
                        }
                        if (start == null && !string.IsNullOrWhiteSpace(seed))
                        {
                            var n = Model.Graph?.Nodes()?.FirstOrDefault();
                            while (n != null)
                            {
                                var loc = n.Val?.Location ?? string.Empty;
                                if (!string.IsNullOrWhiteSpace(loc) && loc.IndexOf(seed, StringComparison.OrdinalIgnoreCase) >= 0) { start = n; break; }
                                n = n.Next;
                            }
                        }
                        if (start == null)
                        {
                            start = Model.Graph?.Nodes()?.FirstOrDefault();
                        }
                        if (start == null)
                        {
                            <div class="text-muted">No relationships to show yet</div>;
                        }
                        else
                        {
                            <div class="small text-muted mb-2">Showing up to 10 related items</div>
                            var shown = 0;
                            foreach (var r in Model.Graph.Bfs(start))
                            {
                                shown++;
                                if (shown > 10) { break; }
                                <div class="d-flex align-items-center justify-content-between small py-1">
                                    <div class="d-flex align-items-center gap-2">
                                        <i class="bi bi-node-plus text-secondary"></i>
                                        <span class="text-truncate" title="@r.Title">@r.Title</span>
                                    </div>
                                    <span class="badge @Badge(r.Status)">@r.Status</span>
                                </div>
                            }
                            if (shown == 0)
                            {
                                <div class="text-muted">No related items found</div>
                            }
                        }
                    }
                    <div class="mt-2 small text-muted">Tip: Work on a cluster of similar items together to save time.</div>
                </div>
            </div>
            }

            <div class="card" style="min-width: 320px;">
                <div class="card-header d-flex align-items-center justify-content-between">
                    <span>Closest Links (Minimal Set)</span>
                    <i class="bi bi-info-circle" title="A simple view of the closest connections between requests. Lower weight = more similar."></i>
                </div>
                <div class="card-body">
                    @if (Model.Graph == null)
                    {
                        <div class="text-muted">No link data available</div>
                    }
                    else
                    {
                        var any = false;
                        foreach (var e in Model.Graph.PrimMst())
                        {
                            any = true;
                            <div class="d-flex align-items-center justify-content-between small py-1">
                                <div class="d-flex align-items-center gap-2 text-truncate">
                                    <i class="bi bi-diagram-2 text-secondary"></i>
                                    <span class="text-truncate" title="@e.Item1.Val.Title">@e.Item1.Val.Title</span>
                                    <span class="mx-2">→</span>
                                    <span class="text-truncate" title="@e.Item2.Val.Title">@e.Item2.Val.Title</span>
                                </div>
                                <span class="ms-2 badge bg-light text-dark" title="Lower is closer">weight @e.Item3</span>
                            </div>
                        }
                        if (!any)
                        {
                            <div class="text-muted">No strong links found</div>
                        }
                    }
                    <div class="mt-2 small text-muted">Tip: Use these links to form a small action group.</div>
                </div>
            </div>
        </div>
    </div>
</div>

@functions {
    private string Badge(Municiple_Project_st10259527.Models.ServiceRequestStatus status)
    {
        return status switch
        {
            Municiple_Project_st10259527.Models.ServiceRequestStatus.Submitted => "bg-warning text-dark",
            Municiple_Project_st10259527.Models.ServiceRequestStatus.InProgress => "bg-info text-dark",
            Municiple_Project_st10259527.Models.ServiceRequestStatus.OnHold => "bg-secondary",
            Municiple_Project_st10259527.Models.ServiceRequestStatus.Completed => "bg-success",
            Municiple_Project_st10259527.Models.ServiceRequestStatus.Cancelled => "bg-danger",
            _ => "bg-secondary"
        };
    }

    private async Task RenderNodeSimple(Municiple_Project_st10259527.Services.DataStructures.TreeNode<Municiple_Project_st10259527.Models.ServiceRequestModel> node)
    {
        if (node == null) return;
        var r = node.Value;
        <tr>
            <td>@r.RequestId</td>
            <td>@r.Title</td>
            <td><span class="badge @Badge(r.Status)">@r.Status</span></td>
            <td><span class="badge bg-light text-dark">Priority @r.Priority</span></td>
            <td>
                <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#requestModal" data-id="@r.RequestId" data-title="@r.Title" data-description="@r.Description" data-location="@r.Location" data-category="@r.Category" data-status="@r.Status" data-priority="@r.Priority" data-userid="@r.UserId">
                    View
                </button>
                <a class="btn btn-sm btn-outline-secondary"
                   href="@Url.Action("ManageServiceRequest","ServiceRequestAdmin", new { 
                        startId = r.RequestId,
                        statusFilter = ViewData["StatusFilter"],
                        categoryFilter = ViewData["CategoryFilter"],
                        priorityFilter = ViewData["PriorityFilter"],
                        locationFilter = ViewData["LocationFilter"]
                   })"
                   title="See related to this request">
                    Related
                </a>
            </td>
        </tr>
        await RenderNodeSimple(node.FirstChild);
        await RenderNodeSimple(node.NextSibling);
    }
}

<!-- Modal -->
<div class="modal fade" id="requestModal" tabindex="-1" aria-labelledby="requestModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="requestModalLabel">Request Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="modal-form" method="post" action="@Url.Action("Update","ServiceRequestAdmin")">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" id="form-id" />
                    <input type="hidden" name="priority" id="form-priority" />
                    <dl class="row">
                        <dt class="col-sm-3">ID</dt><dd class="col-sm-9" id="modal-id"></dd>
                        <dt class="col-sm-3">Title</dt><dd class="col-sm-9" id="modal-title"></dd>
                        <dt class="col-sm-3">Description</dt><dd class="col-sm-9" id="modal-description"></dd>
                        <dt class="col-sm-3">Location</dt><dd class="col-sm-9" id="modal-location"></dd>
                        <dt class="col-sm-3">Category</dt><dd class="col-sm-9" id="modal-category"></dd>
                        <dt class="col-sm-3">Status</dt>
                        <dd class="col-sm-9">
                            <select id="modal-status-select" class="form-select form-select-sm" name="status">
                                <option value="Submitted">Submitted</option>
                                <option value="InProgress">In Progress</option>
                                <option value="OnHold">On Hold</option>
                                <option value="Completed">Completed</option>
                                <option value="Cancelled">Cancelled</option>
                            </select>
                        </dd>
                        <dt class="col-sm-3">Priority</dt><dd class="col-sm-9" id="modal-priority"></dd>
                        <dt class="col-sm-3">User ID</dt><dd class="col-sm-9" id="modal-userid"></dd>
                    </dl>
                    <div class="d-flex justify-content-end mt-3">
                        <button type="submit" class="btn btn-sm btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const requestModal = document.getElementById('requestModal');
    requestModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const id = button.getAttribute('data-id');
        document.getElementById('modal-id').textContent = id;
        const formId = document.getElementById('form-id');
        const formPriority = document.getElementById('form-priority');
        formId.value = id;
        document.getElementById('modal-title').textContent = button.getAttribute('data-title');
        document.getElementById('modal-description').textContent = button.getAttribute('data-description');
        document.getElementById('modal-location').textContent = button.getAttribute('data-location');
        document.getElementById('modal-category').textContent = button.getAttribute('data-category');
        const status = button.getAttribute('data-status');
        const statusSelect = document.getElementById('modal-status-select');
        statusSelect.value = status;
        const currentPriority = button.getAttribute('data-priority');
        document.getElementById('modal-priority').textContent = 'Priority ' + currentPriority;
        formPriority.value = currentPriority;
        document.getElementById('modal-userid').textContent = button.getAttribute('data-userid');

        // No extra JS submit handler needed; form posts directly with anti-forgery token
    });
});
</script>